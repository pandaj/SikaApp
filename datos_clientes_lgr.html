<!--<?php
include 'php__header.php';


// Valida Login
global $login,$get,$extra,$user;
if (!$login) devuelveHome();


// No tienes permiso
if ($user['acceso'] < 3) die('<script> alert("No tienes permiso para ingresar a esta página."); top.location.href = "home.php"; </script>');


// Regiones
$regiones = array(
	"metropolitana"	=> 'Región Metropolitana',
	"region1"		=> 'I Región',
	"region2"		=> 'II Región',
	"region3"		=> 'III Región',
	"region4"		=> 'IV Región',
	"region5"		=> 'V Región',
	"region6"		=> 'VI Región',
	"region7"		=> 'VII Región',
	"region8"		=> 'VIII Región',
	"region9"		=> 'IX Región',
	"region10"		=> 'X Región',
	"region11"		=> 'XI Región',
	"region12"		=> 'XII Región',
	"region14"		=> 'XIV Región',
	"region15"		=> 'XV Región',
	"fuera"			=> 'Fuera de Chile'
);


// Campos
$campos = array(
	'ID',
	'Nombre',
	'Apellido',
	'Email',
	'Teléfono',
	'Empresa',
	'Actividad',
	'Región',
	'Ciudad',
	'Campaña',
	'Registrado Por',
	'Lugar Registro',
	'Fecha Registro'
);


// Carga Base de Datos
$configDB = require_once 'config/db.php';
$conectDB = Zend_Db::factory('Mysqli', $configDB);
Zend_Db_Table_Abstract::setDefaultAdapter($conectDB);


// Carga Clientes
$tablaClien = new Zend_Db_Table('clientes');
$queryClien = $tablaClien->select();
$clientes = $tablaClien->fetchAll($queryClien);
$clientesTotal = count($clientes);


// Carga Usuarios
$tablaUsers = new Zend_Db_Table('users');
$queryUsers = $tablaUsers->select();
$usuarios = $tablaUsers->fetchAll($queryUsers);


// Carga Lugares
$tablaLugar = new Zend_Db_Table('lugares');
$queryLugar = $tablaLugar->select();
$lugares = $tablaLugar->fetchAll($queryLugar);


// Carga Campañas
$tablaCampa = new Zend_Db_Table('campas');
$queryCampa = $tablaCampa->select();
$campas = $tablaCampa->fetchAll($queryCampa);


// Cierra Conexion DB
$conectDB->closeConnection();
$configDB = NULL;
$conectDB = NULL;


// Datos Lugares
$lugarNames = array();
foreach ($lugares as $lugar) :
	$lugarNames[ $lugar['lugar_id'] ] = array(
		'lugar_id'	=> $lugar['lugar_id'],
		'nombre'	=> $lugar['nombre'],
		'region'	=> $lugar['region'],
		'ciudad'	=> $lugar['ciudad'],
		'clientes'	=> array( $campos )
	);
endforeach;
$tablaLugar = NULL;
$queryLugar = NULL;
$lugares = NULL;


// Datos Campañas
$campaNames = array();
foreach ($campas as $campa) :
	$campaNames[ $campa['campa_id'] ] = array(
		'nombre'	=> $campa['nombre']
	);
endforeach;
$tablaCampa = NULL;
$queryCampa = NULL;
$campas = NULL;


// Datos Usuarios
$usersNames = array();
foreach ($usuarios as $usuario) :
	$usersNames[ $usuario['user_id'] ] = array(
		'nombre'	=> $usuario['nombre']
	);
endforeach;
$tablaUsers = NULL;
$queryUsers = NULL;
$usuarios = NULL;


// Datos Clientes
foreach ($clientes as $cliente) :
	$lugarID = $cliente['lugar_id'];
	$lugarNames[ $lugarID ]['clientes'][] = array(
		$cliente['cliente_id'],
		str_replace("'", "´", $cliente['nombre']),
		str_replace("'", "´", $cliente['apellido']),
		$cliente['email'],
		$cliente['fono'],
		str_replace("'", "´", $cliente['empresa']),
		str_replace("'", "´", $cliente['actividad']),
		$regiones[ $cliente['region'] ],
		str_replace("'", "´", $cliente['ciudad']),
		str_replace("'", "´", $campaNames[ $cliente['campa_id'] ]['nombre']),
		str_replace("'", "´", $usersNames[ $cliente['user_id'] ]['nombre']),
		str_replace("'", "´", $lugarNames[ $cliente['lugar_id'] ]['nombre']),
		$cliente['fecha']
	);
endforeach;
$tablaClien = NULL;
$queryClien = NULL;
$clientes = NULL;
?>-->
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="msapplication-tap-highlight" content="no" />
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
	
	<link rel='shortcut icon' type="image/x-icon" href="img/favicon.ico" />
	<link rel="shortcut icon" type="image/png" href="img/favicon.png" />
	<title>Administrador SIKA</title>

	<link href="library/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="library/simple-line-icons/css/simple-line-icons.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">

	<script src="cordova.js"></script>
	<script src="library/jquery/jquery-1.10.2.js"></script>
	<script src="js/main.js"></script>
	<script>
		loginRedirige('index', 3);
	</script>
</head>
<body class="app header-fixed sidebar-fixed aside-menu-fixed aside-menu-hidden">
<style>
	.nav-tabs .nav-item.active {
		background:#ffc107;
	}
	.nav-tabs .nav-item.active a {
		color:#FFF;
	}
</style>

	<!-- Header -->
	<header id="header" class="app-header navbar">
		<script> loadHeader(); </script>
	</header>
	<!-- FIN Header -->

	<!-- Contenido -->
	<div class="app-body">

		<!-- Menu Lateral -->
		<div id="side-menu" class="sidebar">
			<script> loadMenu(); </script>
		</div>
		<!-- FIN Menu Lateral -->

		<!-- Main content -->
		<main class="main">

			<!-- Breadcrumb -->
			<ol class="breadcrumb">
				<li class="breadcrumb-item">Home</li>
				<li class="breadcrumb-item">Datos Detallados</li>
				<li class="breadcrumb-item active">Clientes Por Lugar</li>
			</ol>

			<!-- Contenedor -->
			<div class="container-fluid">
				<div class="animated fadeIn">

					<!-- Datos Globales -->
					<div class="row">
						<div class="col-sm-6 col-lg-3">
							<div class="card text-white bg-primary">
								<div class="card-body pb-0">
									<h4 class="mb-0"><?php echo ponePuntos($clientesTotal); ?></h4>
									<p>Clientes Registrados</p>
								</div>
							</div>
						</div>
					</div>
					<!-- FIN Datos Globales -->

					<!-- Datos -->
					<div class="row">
						<div class="col-md-12">
							<div class="card">
								<div class="card-header">
									Datos de los clientes
								</div>
								<div class="card-body" id="tabla-datos">

									<!-- Menu Tab -->
									<ul class="nav nav-tabs" role="tablist">
										<?php
										$n = 0;
										foreach ($lugarNames as $lugar) :
											if (count($lugar['clientes']) > 1) :
												$n++;
												$activo = '';
												if ($n == 1) $activo = ' active';
												$elName = 'lugar'.$lugar['lugar_id'];
												?>
												<li class="nav-item<?php echo $activo; ?>">
													<a class="nav-link" data-toggle="tab" href="#<?php echo $elName; ?>" role="tab" aria-controls="<?php echo $elName; ?>">
														<?php echo $lugar['nombre']; ?>
													</a>
												</li>
												<?php
											endif;
										endforeach;
										?>
									</ul>
									<!-- FIN Menu Tab -->

									<!-- Tablas -->
									<div class="tab-content">
										<?php
										$n = 0;
										foreach ($lugarNames as $lugar) :
											if (count($lugar['clientes']) > 1) :
												$n++;
												$activo = '';
												if ($n == 1) $activo = ' active';
												$elName = 'lugar'.$lugar['lugar_id'];
												?>
												<div class="tab-pane<?php echo $activo; ?>" id="<?php echo $elName; ?>" role="tabpanel">
                                                	<div class="card-header">
														Lugar : <b><?php echo $lugar['nombre'].'</b> <small>'.$lugar['ciudad'].', '.$regiones[ $lugar['region'] ].'</small>'; ?>
													</div>
													<form class="card-body" style="padding-bottom:0;" method="post" action="adminExcel.php">
														<input type="hidden" name="datos" value='<?php echo json_encode($lugar['clientes']); ?>' />
														<input type="hidden" name="nombre" value='<?php echo $elName; ?>' />
														<button type="button" class="btn btn-danger btn-lg" onClick="$('#<?php echo $elName; ?> form').submit();">Exportar datos para EXCEL</button>
													</form>
													<table class="table table-responsive-sm table-striped">
														<?php
														$n = 0;
														foreach ($lugar['clientes'] as $cliente) :
															$n++;
															if ($n == 1) :
																?>
																<thead><tr>
																	<?php foreach ($cliente as $dato) : ?>
																		<th><?php echo $dato; ?></th>
																	<?php endforeach; ?>
																</tr></thead>
																<?php
															else :
																?>
																<tbody><tr>
																	<?php foreach ($cliente as $dato) : ?>
																		<td><?php echo $dato; ?></td>
																	<?php endforeach; ?>
																</tr></tbody>
																<?php
															endif;
														endforeach;
														?>
													</table>
												</div>
												<?php
											endif;
										endforeach;
										?>
									</div>
								</div>
							</div>
						</div>
						<!--/.col-->

					</div>
					<!--/.row-->

				</div>
			</div>
			<!-- /.conainer-fluid -->

		</main>
	</div>

	<!-- Footer -->
	<footer class="app-footer">
		<span>Powered by <a href="http://redon.cl" target="_blank">Redon©</a> 2018.</span>
	</footer>
	<script src="library/popper/popper.min.js"></script>
	<script src="library/bootstrap/bootstrap.min.js"></script>
	<script src="js/app.js"></script>
	<!-- FIN Footer -->

	<script src="library/pace/pace.min.js"></script>
	<script src="library/chart/Chart.min.js"></script>
	<!--<script src="js/views/main.js"></script>-->

</body>
</html>